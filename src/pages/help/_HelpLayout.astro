---
import { ViewTransitions } from 'astro:transitions';
import Sidebar from '../../components/Sidebar.astro';

import '../../styles/common.css';
import '../../styles/style.css';
import '../../styles/custom.css';

const { title, activeMenu, activeGroup, showBackButton = true, pageClass = '' } = Astro.props;
const homePath = '/eg-bim_guide/help/';
---

<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="format-detection" content="telephone=no" />
  <link rel="shortcut icon" type="image/svg+xml" href="../favicon.svg" />
  <title>{title}</title>
  <ViewTransitions />
  <style is:inline>
    ::view-transition-old(root),
    ::view-transition-new(root) { animation-duration: 0.2s; }
    ::view-transition-old(sidebar),
    ::view-transition-new(sidebar) { animation: none; }
    .nav-wrap { view-transition-name: sidebar; }
  </style>
</head>

<body>
   <div class={`wrap ${pageClass ? `page-${pageClass}` : ''}`}>
    <div class="nav-wrap" transition:persist transition:name="sidebar">
      <header class="header">
        <h1>ì´ìš©ê°€ì´ë“œ</h1>
      </header>
      <Sidebar activeMenu={activeMenu} activeGroup={activeGroup} />
    </div>

    <div class="container">
      <div id="main-content">
        <slot />
      </div>
    </div>
  </div>

<script>
(function() {
  const homePath = '{homePath}';

  /* ------------------------------
    ê³µí†µ DOM í—¬í¼
  ------------------------------ */
  const $ = selector => document.querySelector(selector);
  const $$ = selector => [...document.querySelectorAll(selector)];

  const toggleSearchResults = (show = false) => {
    const searchContainer = $('#search-results-container');
    const mainContent = $('#main-content');
    if (searchContainer) searchContainer.style.display = show ? 'block' : 'none';
    if (mainContent) mainContent.style.display = show ? 'none' : 'block';
    const searchInput = $('#search-input');
    if (searchInput) {
      searchInput.value = '';
      const clearBtn = $('#search-clear-btn');
      if (clearBtn) clearBtn.style.display = 'none';
    }
  };

  /* ------------------------------
    í˜„ì¬ íƒ­ì´ commandsì¸ì§€ í™•ì¸
  ------------------------------ */
  function isCommandsTab() {
    const activeTabContent = $('.tab-content.active');
    return activeTabContent?.classList.contains('grid-layout');
  }

  /* ------------------------------
    ë©”ë‰´ ìƒíƒœ ë³µì› (updateSidebar í˜¸ì¶œ ì „)
  ------------------------------ */
  function restoreMenuStateBeforeUpdate() {
    const activeTabBtn = $('.tab-button.active');
    const tabId = activeTabBtn?.dataset.tab;
    
    // grimmi íƒ­ì´ê³  ì €ì¥ëœ ìƒíƒœê°€ ìˆìœ¼ë©´ ë³µì›
    if (tabId === 'grimmi') {
      const savedState = sessionStorage.getItem(`menuState_${tabId}`);
      if (savedState) {
        try {
          const openMenus = JSON.parse(savedState);
          openMenus.forEach(toggleId => {
            const depth02 = document.getElementById(toggleId);
            const parentLi = depth02?.closest('.depth01 > li');
            if (depth02 && parentLi && !depth02.classList.contains('single')) {
              depth02.classList.remove('d-none');
              parentLi.classList.add('active');
            }
          });
        } catch (e) {
          console.warn('Failed to restore menu state:', e);
        }
      }
    }
  }

  /* ------------------------------
    ì‚¬ì´ë“œë°” + íƒ­ í™œì„±í™”
  ------------------------------ */
  function updateSidebar() {
    const currentPath = window.location.pathname;
    let longestMatch = 0, matchedLink = null;

    // ğŸ”¹ ê°€ì¥ ê¸´ ê²½ë¡œë¥¼ ê°€ì§„ ë§í¬ ì°¾ê¸° (ì •í™•í•œ ë§¤ì¹­)
    $$('a[data-page]').forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;
      
      const linkPath = new URL(href, location.origin).pathname;
      
      // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ í˜„ì¬ ê²½ë¡œê°€ ë§í¬ ê²½ë¡œë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°
      if (currentPath === linkPath || currentPath.startsWith(linkPath + '/')) {
        if (linkPath.length > longestMatch) {
          matchedLink = link;
          longestMatch = linkPath.length;
        }
      }
    });
    
    if (!matchedLink) return;

    requestAnimationFrame(() => {
      // ğŸ”¹ ë¨¼ì € ì €ì¥ëœ ë©”ë‰´ ìƒíƒœ ë³µì› (grimmi íƒ­ìš©)
      restoreMenuStateBeforeUpdate();

      const isCommands = isCommandsTab();

      // ğŸ”¹ depth02, depth03ì˜ activeëŠ” í•­ìƒ ì œê±° (í˜„ì¬ ì„ íƒëœ í˜ì´ì§€ë§Œ í‘œì‹œ)
      $$('.depth02 li.active, .depth03 li.active').forEach(li => li.classList.remove('active'));

      // ğŸ”¹ commands íƒ­ì¼ ê²½ìš°ì—ë§Œ depth01 active ì œê±° (í•˜ë‚˜ë§Œ ì—´ë¦¼)
      if (isCommands) {
        $$('.depth01 > li.active').forEach(li => li.classList.remove('active'));
        $$('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
      }
      // grimmi íƒ­ì¼ ê²½ìš° depth01 active ìƒíƒœ ìœ ì§€ (ì—¬ëŸ¬ ê°œ ì—´ë¦¼ ê°€ëŠ¥)
      
      // ë§¤ì¹­ëœ ë§í¬ì˜ lië§Œ í™œì„±í™”
      const li = matchedLink.closest('li');
      li?.classList.add('active');
      
      // ë¶€ëª¨ depth01 > li í™œì„±í™”
      const parent = matchedLink.closest('.depth01 > li');
      parent?.classList.add('active');
      const parentDepth02 = parent?.querySelector('.depth02');
      if (parentDepth02 && !parentDepth02.classList.contains('single')) {
        parentDepth02.classList.remove('d-none');
      }

      // íƒ­ í™œì„±í™”
      const tabContent = matchedLink.closest('.tab-content');
      if (tabContent) {
        const tabId = tabContent.getAttribute('data-tab-content');
        $$('.tab-button.active').forEach(btn => btn.classList.remove('active'));
        $$('.tab-content.active').forEach(c => { if (c !== tabContent) c.classList.remove('active'); });
        $(`.tab-button[data-tab="${tabId}"]`)?.classList.add('active');
        tabContent.classList.add('active');
      }
    });
  }

  /* ------------------------------
    ë·°í¬íŠ¸ ë†’ì´ CSS ë³€ìˆ˜
  ------------------------------ */
  const syncHeight = () => document.documentElement.style.setProperty('--window-inner-height', `${window.innerHeight}px`);

  /* ------------------------------
    ì´ˆê¸°í™”
  ------------------------------ */
  const initLayout = () => {
    syncHeight();
    updateSidebar();
  };

  window.addEventListener('resize', syncHeight);
  window.addEventListener('popstate', () => { 
    toggleSearchResults(false); 
    updateSidebar();
   });
  document.addEventListener('astro:page-load', initLayout);
  document.addEventListener('astro:before-preparation', e => {
    const newUrl = e?.newDocument?.location?.pathname;
    if (!newUrl) return;
    
    // ğŸ”¹ ì •í™•í•œ ê²½ë¡œ ë§¤ì¹­
    $$('a[data-page]').forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;
      
      const linkPath = new URL(href, location.origin).pathname;
      if (newUrl === linkPath || newUrl.startsWith(linkPath + '/')) {
        link.closest('li')?.classList.add('active');
      }
    });
  });

  initLayout();

 window.addEventListener("DOMContentLoaded", () => {
    const btnHome = document.getElementById("btn-home");
    if (!btnHome) return;

    const aOrigin = "https://eg-bim.co.kr/egbim1/index.php";

    btnHome.addEventListener("click", () => {
      
      try {
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage({ type: "focus-request" }, aOrigin);
          
        } else {
          
          window.open(aOrigin, "_blank", "noopener");
        }
      } catch (err) {
       
        console.warn("ì°½ í¬ì»¤ìŠ¤ ì‹¤íŒ¨, ìƒˆì°½ìœ¼ë¡œ ì—´ê¸°", err);
        window.open(aOrigin, "_blank", "noopener");
      }
    });
  });
})();
</script>