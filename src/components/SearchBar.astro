---
import Fuse from "fuse.js";
import { generateSearchData } from '../lib/searchIndex.js';
const searchData = await generateSearchData(); // ì„œë²„ì—ì„œ ìƒì„±
---

<div class="searchbar-wrapper">
  <!-- ê²€ìƒ‰ ì…ë ¥ ì˜ì—­ -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <input id="search-input" type="text" placeholder="ê²€ìƒ‰" autocomplete="off" />
      <button id="search-clear-btn" class="search-clear-btn" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">âœ•</button>
      <span class="search-icon" title="ê²€ìƒ‰">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" >
          <path d="M11.1681 6.18235C11.1681 3.42879 8.93592 1.19658 6.18235 1.19658C3.42879 1.19658 1.19658 3.42879 1.19658 6.18235C1.19658 8.93592 3.42879 11.1681 6.18235 11.1681C8.93592 11.1681 11.1681 8.93592 11.1681 6.18235ZM12.3647 6.18235C12.3647 7.67411 11.836 9.04217 10.9562 10.1102L15.3803 14.5343C15.614 14.7679 15.614 15.1467 15.3803 15.3803C15.1467 15.614 14.7679 15.614 14.5343 15.3803L10.1102 10.9562C9.04217 11.836 7.67411 12.3647 6.18235 12.3647C2.76793 12.3647 0 9.59677 0 6.18235C0 2.76793 2.76793 0 6.18235 0C9.59677 0 12.3647 2.76793 12.3647 6.18235Z" fill="#000"/>
        </svg>
      </span>
    </div>

    <!-- ìµœê·¼ ê²€ìƒ‰ì–´ ë“œë¡­ë‹¤ìš´ -->
    <div id="search-history-dropdown" class="search-history-dropdown" style="display:none;">
      <div class="search-history-inner">
        <ul id="history-list" class="history-list"></ul>
      </div>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
  <div id="search-results-container" class="search-results-container" style="display: none;">
    <div class="search-results-header">
      <p class="results-count">
        <strong id="current-search-query"></strong><!-- ì— ëŒ€í•œ ê²°ê³¼ -->
        <span id="results-count">0</span> <!--ê±´-->
      </p>
    </div>
    <div class="search-list-wrap">
      <div id="search-results-list" class="search-results-list">
        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>
</div>

<script define:vars={{ searchData }}>
document.addEventListener('astro:page-load', () => new SearchManager(searchData));

class SearchManager {
  constructor(searchData) {
    this.data = searchData;
    this.fuse = new Fuse(searchData, {
      includeScore: true,
      threshold: 0.6,
      ignoreLocation: true,
      minMatchCharLength: 1,
      distance: 200,
      keys: [
        { name: "title", weight: 0.65 },
        { name: "fullContent", weight: 0.35 },
      ],
    });
    this.input = document.getElementById('search-input');
    this.clearBtn = document.getElementById('search-clear-btn');
    this.dropdown = document.getElementById('search-history-dropdown');
    this.historyList = document.getElementById('history-list');
    this.resultsContainer = document.getElementById('search-results-container');
    this.resultsList = document.getElementById('search-results-list');
    this.resultsCount = document.getElementById('results-count');
    this.currentQuery = document.getElementById('current-search-query');

    this.history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    this.historyFocusIndex = -1;
    this.resultsFocusIndex = -1;
    this.currentResultItems = [];
    this.debounceTimer = null;
    this.debug = this.isDebugEnabled();

    if (!this.input || !this.clearBtn || !this.dropdown || !this.historyList) return;

    this.bindEvents();
    this.updateClearButton();
    this.initURLQuery();
  }

  bindEvents() {
    this.input.addEventListener('focus', () => this.onFocus());
    this.input.addEventListener('input', () => this.onInput());
    this.input.addEventListener('keydown', e => this.onKeydown(e));
    this.clearBtn.addEventListener('click', e => this.onClear(e));
    document.addEventListener('mousedown', e => this.onOutsideClick(e), true);
  }

  normalize(str) {
    return str.replace(/&nbsp;|[\s]+/g, ' ').toLowerCase();
  }

  normalizeLoose(str) {
    return this.normalize(str).replace(/\s+/g, '');
  }

  onFocus() {
    const value = this.input.value.trim();
    if (value.length >= 2) this.performSearch(value);
    else this.updateHistoryDisplay();
  }

  onInput() {
    this.updateClearButton();
    clearTimeout(this.debounceTimer);
    const value = this.input.value.trim();
    if (value.length >= 2) {
      this.debounceTimer = setTimeout(() => this.performSearch(value), 250);
    } else {
      this.clearResults();
      this.updateHistoryDisplay();
    }
  }

  onClear(e) {
    e.preventDefault();
    this.input.value = '';
    this.updateClearButton();
    this.clearResults();
    this.updateHistoryDisplay();
    this.input.focus();
  }

  onOutsideClick(e) {
    if (!e.target.closest('.searchbar-wrapper')) {
      this.hideDropdown();
      this.hideResults();
      if (this.input !== document.activeElement) this.clearResults();
    }
  }

  performSearch(queryRaw) {
    const query = queryRaw.trim();
    if (query.length < 2) return this.clearResults();
    // ğŸ”¹ ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    this.saveToHistory(query);

    const queryLoose = this.normalizeLoose(query);
    const fuseResults = this.fuse.search(query);
    const fuzzyMatched = fuseResults.map(r => ({ ...r.item, score: r.score ?? 0 }));

    // ë‹¨ìˆœ í¬í•¨(ê³µë°± ì œê±°) fallback
    const simpleMatched = this.data
      .filter(d => {
        const titleLoose = this.normalizeLoose(d.title);
        const contentLoose = this.normalizeLoose(d.fullContent || '');
        return titleLoose.includes(queryLoose) || contentLoose.includes(queryLoose);
      })
      .map(d => ({ ...d, score: 0.8 })); // fuzzë³´ë‹¤ ë‚®ì€ ìš°ì„ ìˆœìœ„ì§€ë§Œ ê²°ê³¼ ë³´ê°•

    // ë³‘í•© & dedup by url
    const merged = [...fuzzyMatched, ...simpleMatched];
    const seen = new Set();
    const matched = merged.filter(item => {
      if (seen.has(item.url)) return false;
      seen.add(item.url);
      return true;
    });

    // typeë³„ ê·¸ë£¹í™”
    const grouped = matched.reduce((acc, item) => {
      (acc[item.type] = acc[item.type] || []).push(item);
      return acc;
    }, {});

    // ê° ê·¸ë£¹ ìµœëŒ€ 50ê°œ ì œí•œ + ì ìˆ˜ë¡œ ì •ë ¬
    Object.keys(grouped).forEach(k => {
      grouped[k] = grouped[k]
        .sort((a, b) => a.score - b.score)
        .slice(0, 50);
    });

    // flatten
    const finalResults = Object.values(grouped).flat();
    this.renderResults(finalResults, query);
    this.hideDropdown();
    this.logDebugResults(finalResults, query);
  }

  executeSearch(queryRaw) {
    if (queryRaw.trim().length < 2) return;
    this.saveToHistory(queryRaw);
    this.performSearch(queryRaw);
  }

  renderResults(results, query) {
    this.currentQuery.textContent = query;
    this.resultsFocusIndex = -1;

    if (!results.length) {
    this.resultsList.innerHTML = `
      <div class="no-results">
        <div class="no-results-text">
          <strong>"${query}"</strong>ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    `;
    this.resultsCount.textContent = '0';
    this.showResults();
    this.currentResultItems = [];
    return;
  }

  // ê·¸ë£¹í™”
  const groups = {
    command: results.filter(r => r.type === 'mdx').slice(0, 50),
    page: results.filter(r => r.type !== 'mdx').slice(0, 50),
  };

  // ğŸ”¹ í˜„ì¬ í™œì„± íƒ­ í™•ì¸
  const activeTab = document.querySelector('[data-tab].active');
  const activeType = activeTab?.dataset.tab;
  const order = activeType === 'commands' ? ['command', 'page'] : ['page', 'command'];

  // ğŸ”¹ ê·¸ë£¹ë³„ ì¹´ìš´íŠ¸
  const countCommand = groups.command.length;
  const countPage = groups.page.length;
  const totalCount = countCommand + countPage;

  // ğŸ”¹ ê²°ê³¼ ìˆ˜ í‘œì‹œ ìˆ˜ì •
  /*
  this.resultsCount.innerHTML = `
    ${totalCount}ê±´ 
    <span class="sub-count">(ê°€ì´ë“œ ${countPage}ê±´ / ëª…ë ¹ì–´ ${countCommand}ê±´)</span>
  `;
  */

  const debugBadge = this.debug
    ? '<span class="result-badge badge-score">DEBUG: score í‘œì‹œ</span>'
    : '';

  this.resultsCount.innerHTML = `
    ê°€ì´ë“œ <strong>${countPage} ê±´</strong> / ëª…ë ¹ì–´ <strong>${countCommand} ê±´</strong>
    ${debugBadge}
  `;

  // ğŸ”¹ HTML ì¡°ë¦½
  const htmlSections = [];
  for (const type of order) {
    const group = groups[type];
    if (!group.length) continue;

    const title = type === 'command' ? 'ëª…ë ¹ì–´' : 'ê°€ì´ë“œ';
    htmlSections.push(`
      <div class="search-group" data-tab="${type}">
        <div class="group-title">${title}</div>
        ${group.map(item => this.renderResultItem(item, query)).join('')}
      </div>
    `);
  }

  this.resultsList.innerHTML = htmlSections.join('');
  this.showResults();

  this.currentResultItems = Array.from(this.resultsList.querySelectorAll('.search-result-item'));
  this.bindResultClicks();
  this.resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}


  renderResultItem(item, query) {
    const titleHtml = item.title.replace(
      new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'),
      '<mark>$1</mark>'
    );
    const typeBadge = item.type === 'mdx'
      ? '<span class="result-badge badge-command">ëª…ë ¹ì–´</span>'
      : '<span class="result-badge badge-page">ê°€ì´ë“œ</span>';
    const urlWithQuery = `${item.url}?search=${encodeURIComponent(query)}`;
    const scoreBadge = this.debug && typeof item.score === 'number'
      ? `<span class="result-badge badge-score">score: ${item.score.toFixed(3)}</span>`
      : '';

    return `
      <div class="search-result-item" tabindex="-1" data-type="${item.type}">
        <a href="${urlWithQuery}">
          <div class="result-title">
            <span class="title-text">${titleHtml}</span>
            ${typeBadge}
            ${scoreBadge}
          </div>
          <div class="result-preview">${this.createPreview(item.fullContent, query)}</div>
        </a>
      </div>
    `;
  }
  


  createPreview(content, query) {
    const normalizedContent = content.replace(/&nbsp;|[\s]+/g, ' ');
    const pos = normalizedContent.toLowerCase().indexOf(query.toLowerCase());
    const snippet = pos === -1
      ? normalizedContent.slice(0, 300)
      : normalizedContent.slice(Math.max(0, pos - 100), Math.min(normalizedContent.length, pos + query.length + 200));
    const segment = snippet.split('\n').slice(0, 2).join(' ').trim();
    return segment.replace(new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>') + '...';
  }

  bindResultClicks() {
    this.currentResultItems.forEach(item => {
      const link = item.querySelector('a');
      if (!link) return;
      link.addEventListener('click', e => {
        const targetPath = new URL(link.href, location.origin).pathname;
        const sidebar = document.querySelector('.lnb-container');
        if (sidebar) {
          sidebar.querySelectorAll('.depth01 > li').forEach(li => li.classList.remove('active'));
          sidebar.querySelectorAll('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
        }

        document.addEventListener('astro:page-load', () => {
          const sidebar = document.querySelector('.lnb-container');
          if (!sidebar) return;
          const targetAnchor = [...sidebar.querySelectorAll('a[data-page]')].find(a => new URL(a.href, location.origin).pathname === targetPath);
          if (targetAnchor) {
            const li = targetAnchor.closest('li');
            const parentLi = targetAnchor.closest('.depth01 > li');
            li?.classList.add('active');
            parentLi?.classList.add('active');
            parentLi?.querySelector('.depth02')?.classList.remove('d-none');
          }
        }, { once: true });
      });
    });
  }

  clearResults() {
    this.hideResults();
    this.resultsList.innerHTML = '';
    this.currentResultItems = [];
    this.resultsFocusIndex = -1;
  }

  saveToHistory(query) {
    const q = query.trim();
    this.history = [q, ...this.history.filter(h => h.toLowerCase() !== q.toLowerCase())].slice(0, 10);
    localStorage.setItem('searchHistory', JSON.stringify(this.history));
  }

  renderHistory() {
    if (!this.history.length) { this.dropdown.classList.remove("on"); this.dropdown.style.display='none'; return; }
    this.historyList.innerHTML = this.history.map(q => `
      <li class="history-item" tabindex="-1">
        <span class="text" data-query="${q}">${q}</span>
        <button class="delete-btn" title="ì‚­ì œ">âœ•</button>
      </li>
    `).join('');
    this.historyList.querySelectorAll('.history-item').forEach(item => {
      const text = item.querySelector('.text');
      const del = item.querySelector('.delete-btn');
      text.addEventListener('click', () => this.selectHistoryItem(text.dataset.query));
      del.addEventListener('click', e => this.deleteHistoryItem(e, text.dataset.query));
    });
  }

  updateHistoryDisplay() {
    if (!this.input.value.trim() && this.history.length > 0) this.renderHistory(), this.showDropdown();
    else this.hideDropdown();
    this.historyFocusIndex = -1;
  }

  deleteHistoryItem(e, query) {
    e.stopPropagation();
    this.history = this.history.filter(h => h !== query);
    localStorage.setItem('searchHistory', JSON.stringify(this.history));
    this.updateHistoryDisplay();
  }

  selectHistoryItem(query) {
    this.input.value = query;
    this.updateClearButton();
    this.executeSearch(query);
    this.input.focus();
  }

  updateClearButton() {
    this.clearBtn.style.display = this.input.value.trim() ? 'flex' : 'none';
  }

  showDropdown() { this.dropdown.classList.add('on'); this.dropdown.style.display='block'; }
  hideDropdown() { this.dropdown.classList.remove('on'); this.dropdown.style.display='none'; this.historyFocusIndex=-1; }
  showResults() { this.resultsContainer.classList.add('on'); this.resultsContainer.style.display='block'; }
  hideResults() { this.resultsContainer.classList.remove('on'); this.resultsContainer.style.display='none'; }

  initURLQuery() {
    const urlQuery = new URLSearchParams(window.location.search).get('search');
    if (urlQuery) { this.input.value = urlQuery; this.updateClearButton(); this.executeSearch(urlQuery); }
  }

  isDebugEnabled() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('search_debug') === '1') {
      localStorage.setItem('searchDebug', '1');
      return true;
    }
    const stored = localStorage.getItem('searchDebug');
    return stored === '1';
  }

  logDebugResults(_results, _query) {
    // ì½˜ì†” ë””ë²„ê·¸ ì œê±°
  }

  onKeydown(e) {
    const value = this.input.value.trim();
    if (e.key==='Escape'){this.hideDropdown(); this.hideResults(); this.historyFocusIndex=-1; this.resultsFocusIndex=-1; return;}

    if (this.dropdown.classList.contains('on')){
      const items = Array.from(this.historyList.querySelectorAll('.history-item'));
      if (!items.length) return;
      if (e.key==='ArrowDown'){ this.historyFocusIndex = (this.historyFocusIndex+1) % items.length; items.forEach(i=>i.classList.remove('focused')); items[this.historyFocusIndex].classList.add('focused'); e.preventDefault(); }
      if (e.key==='ArrowUp'){ this.historyFocusIndex = (this.historyFocusIndex-1+items.length) % items.length; items.forEach(i=>i.classList.remove('focused')); items[this.historyFocusIndex].classList.add('focused'); e.preventDefault(); }
      if (e.key==='Enter'){ if(this.historyFocusIndex>-1){ const q=items[this.historyFocusIndex].querySelector('.text').dataset.query; this.selectHistoryItem(q); e.preventDefault(); } }
      return;
    }

    if (this.resultsContainer.classList.contains('on')){
      if (!this.currentResultItems.length) return;
      if (e.key==='ArrowDown'){ this.resultsFocusIndex = (this.resultsFocusIndex+1) % this.currentResultItems.length; this.focusResult(this.resultsFocusIndex); e.preventDefault(); }
      if (e.key==='ArrowUp'){ this.resultsFocusIndex = (this.resultsFocusIndex-1+this.currentResultItems.length+1) % this.currentResultItems.length; this.focusResult(this.resultsFocusIndex); e.preventDefault(); }
      if (e.key==='Enter'){ if(this.resultsFocusIndex>-1){ this.currentResultItems[this.resultsFocusIndex].querySelector('a').click(); e.preventDefault(); } }
      return;
    }
  }

  focusResult(index) {
    this.currentResultItems.forEach(i=>i.classList.remove('focused'));
    if (index>-1) this.currentResultItems[index].classList.add('focused'), this.currentResultItems[index].scrollIntoView({block:'nearest'});
  }
}

if (typeof window !== 'undefined') {
  const params = new URLSearchParams(window.location.search);
  if (params.get('search_debug') === '1' || localStorage.getItem('searchDebug') === '1') {
    document.body.insertAdjacentHTML(
      'afterbegin',
      '<div style="position:fixed;top:0;right:0;padding:6px 10px;background:#111;color:#fff;font-size:12px;z-index:9999;">SEARCH DEBUG ON</div>'
    );
  }
}
