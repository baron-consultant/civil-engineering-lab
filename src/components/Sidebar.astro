---
import { getSidebarTabs } from '../lib/sidebarConfig';
import SearchBar from './SearchBar.astro';

const {activeMenu } = Astro.props;

const sidebarTabs = await getSidebarTabs();

const isActive = (id: string) => activeMenu === id || activeMenu.includes(id);

// ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠ Í≤∞Ï†ï (activeMenuÍ∞Ä ÏÜçÌïú ÌÉ≠)
function getActiveTab() {
  // 1Ô∏è‚É£ activeMenu Í∏∞Î∞òÏúºÎ°ú ÌÉ≠ Ï∞æÍ∏∞
  for (const tab of sidebarTabs) {
    for (const group of tab.groups) {
      for (const item of group.items) {
        if (isActive(item.id)) return tab.id;
        if (item.children) {
          for (const child of item.children) {
            if (isActive(child.id)) return tab.id;
          }
        }
      }
    }
  }
  
  // 2Ô∏è‚É£ Astro.urlÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏÑúÎ≤Ñ/ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Î™®ÎëêÏóêÏÑú URL Í∏∞Î∞ò ÌÉ≠ Í≤∞Ï†ï
  const currentPath = Astro.url.pathname;
  if (currentPath.includes('/ko/commands/')) {
    return 'commands';
  }
  
  // 3Ô∏è‚É£ activeMenu Î¨∏ÏûêÏó¥Î°ú ÌåêÎã®
  if (activeMenu && activeMenu.includes('commands')) {
    return 'commands';
  }
  
  return sidebarTabs[0]?.id || 'grimmi';
}

const activeTab = getActiveTab();

// Í∞Å ÌÉ≠Ïùò Ï≤´ Î≤àÏß∏ ÎßÅÌÅ¨ Ï∞æÍ∏∞ Ìï®Ïàò
function getFirstLinkForTab(tab: any): string {
  for (const group of tab.groups) {
    for (const item of group.items) {
      // ÏßÅÏ†ë ÎßÅÌÅ¨Í∞Ä ÏûàÎäî Í≤ΩÏö∞
      if (item.href) return item.href;
      
      // ÏûêÏãùÏù¥ ÏûàÎäî Í≤ΩÏö∞ Ï≤´ Î≤àÏß∏ ÏûêÏãùÏùò ÎßÅÌÅ¨
      if (item.children && item.children.length > 0) {
        const firstChild = item.children[0];
        if (firstChild.href) return firstChild.href;
        
        // ÏÜêÏûêÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
        if (firstChild.children && firstChild.children.length > 0) {
          return firstChild.children[0].href;
        }
      }
    }
  }
  return '#';
}
---

<!-- ÌÉ≠ Î©îÎâ¥ -->
<div class="sidebar-wrap">
    <div class="searchbar-wrapper" >
      <SearchBar />
    </div>
    <div class="sidebar-tabs">
      <span class="tab-btn-bg"></span>
      {sidebarTabs.map(tab => (
        <button 
          class={`tab-button ${activeTab === tab.id ? 'active' : ''}`}
          data-tab={tab.id}
          data-tab-link={getFirstLinkForTab(tab)}
        >
          {tab.icon && <i class={tab.icon}></i>}
          <span>{tab.label}</span>
        </button>
      ))}
    </div>
  
  </div>
<div class="lnb-container">
  <!-- ÌÉ≠ Ïª®ÌÖêÏ∏† -->
  {sidebarTabs.map(tab => (
    <div 
      class={`tab-content ${activeTab === tab.id ? 'active' : ''} ${tab.id === 'commands' ? 'grid-layout' : ''}`}
      data-tab-content={tab.id}
    >
      {tab.groups.map((group, groupIdx) => (
        <div class="nav-group">
          <div class="group-tit">
            <h2><i class={group.icon}></i>{group.title}</h2>
          </div>

          <ul class="depth01">
            {group.items.map((item, idx) => {
              const menuId = `${tab.id}_menuGroup${String(groupIdx * 10 + idx + 1).padStart(2, '0')}`;
              
              // üîπ ÎùºÎ≤®Ïù¥ ÏóÜÏúºÎ©¥ singleÎ°ú Ï≤òÎ¶¨
              const isSingleItem = item.children && !item.label;
              
              return (
                <li class={isActive(item.id) ? 'active' : ''}>
                  {item.children ? (
                    <>
                      {/* üîπ singleÏù∏ Í≤ΩÏö∞ depth01 > li > a ÏóÜÏù¥ Î∞îÎ°ú depth02 */}
                      {!isSingleItem && (
                        <a href="#" data-toggle={menuId}>
                          <i class="ico-arrow"></i>
                          <span>{item.label}</span>
                        </a>
                      )}
                      
                      <ul class={`depth02 ${isSingleItem ? 'single' : (isActive(item.id) ? '' : 'd-none')}`} id={menuId}>
                        {item.children.map((child) => (
                          <li class={isActive(child.id) ? 'active' : ''}>
                            <a href={child.href || '#'} data-page={child.id}>
                              {child.children && (
                                <i class="ico-line"></i>
                              )} 
                              <span>{child.label}</span>
                            </a>
                            
                            {child.children && (
                              <ul class="depth03">
                                {child.children.map((grandChild) => (
                                  <li class={isActive(grandChild.id) ? 'active' : ''}>
                                    <a href={grandChild.href} data-page={grandChild.id}>
                                      <span>{grandChild.label}</span>
                                    </a>
                                  </li>
                                ))}
                              </ul>
                            )}
                          </li>
                        ))}
                      </ul>
                    </>
                  ) : (
                    <ul class="depth02 single">
                      <li class={isActive(item.id) ? 'active' : ''}>
                        <a href={item.href} data-page={item.id}>
                          <span>{item.label}</span>
                        </a>
                      </li>
                    </ul>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      ))}
    </div>
  ))}
</div>
<script>
import { navigate } from 'astro:transitions/client';

/* ------------------------------
  ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÌÅ¨Î°§ ÏÉÅÌÉú Ï†ÄÏû•
------------------------------ */
function saveSidebarScroll() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab || 'default';

  sessionStorage.setItem(`scroll_${tabId}`, sidebar.scrollTop);
}

/* ------------------------------
  ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÌÅ¨Î°§ Î≥µÏõê
------------------------------ */
function restoreSidebarScroll() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab || 'default';

  const savedScroll = sessionStorage.getItem(`scroll_${tabId}`);
  if (savedScroll) {
    sidebar.scrollTop = parseFloat(savedScroll);
  }
}

/* ------------------------------
  Î©îÎâ¥ Ïó¥Î¶º ÏÉÅÌÉú Ï†ÄÏû• (grimmi ÌÉ≠Ïö©)
------------------------------ */
function saveMenuState() {
  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab;
  
  // grimmi ÌÉ≠Îßå ÏÉÅÌÉú Ï†ÄÏû•
  if (tabId === 'grimmi') {
    const openMenus = [];
    document.querySelectorAll('.tab-content.active .depth01 > li.active').forEach(li => {
      const toggleLink = li.querySelector('a[data-toggle]');
      if (toggleLink) {
        const toggleId = toggleLink.getAttribute('data-toggle');
        if (toggleId) openMenus.push(toggleId);
      }
    });
    sessionStorage.setItem(`menuState_${tabId}`, JSON.stringify(openMenus));
  }
}

/* ------------------------------
  Î©îÎâ¥ Ïó¥Î¶º ÏÉÅÌÉú Î≥µÏõê (grimmi ÌÉ≠Ïö©)
------------------------------ */
function restoreMenuState() {
  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab;
  
  // grimmi ÌÉ≠Îßå ÏÉÅÌÉú Î≥µÏõê
  if (tabId === 'grimmi') {
    const savedState = sessionStorage.getItem(`menuState_${tabId}`);
    if (savedState) {
      try {
        const openMenus = JSON.parse(savedState);
        openMenus.forEach(toggleId => {
          const depth02 = document.getElementById(toggleId);
          const parentLi = depth02?.closest('.depth01 > li');
          if (depth02 && parentLi && !depth02.classList.contains('single')) {
            depth02.classList.remove('d-none');
            parentLi.classList.add('active');
          }
        });
      } catch (e) {
        console.warn('Failed to restore menu state:', e);
      }
    }
  }
}

/* ------------------------------
  Ï§ëÏïôÏúºÎ°ú Ïä§ÌÅ¨Î°§ÏãúÏºúÏ£ºÎäî Ìï®Ïàò
------------------------------ */
function scrollActiveDepth02IntoView() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeItem = sidebar.querySelector('.depth02 > li.active, .depth03 > li.active');
  if (!activeItem) return;

  const sidebarRect = sidebar.getBoundingClientRect();
  const itemRect = activeItem.getBoundingClientRect();
  const visibleHeight = sidebar.clientHeight;

  const targetScroll =
    activeItem.offsetTop - visibleHeight / 2 + activeItem.offsetHeight / 2;

  const thresholdBottom = sidebarRect.bottom - 160;
  const thresholdTop = sidebarRect.top + 280;
  
  if (itemRect.top < thresholdTop || itemRect.bottom > thresholdBottom) {
    sidebar.scrollTo({
      top: targetScroll,
      behavior: 'smooth',
    });
  }
}

/* ------------------------------
  ÏÇ¨Ïù¥ÎìúÎ∞î Ï¥àÍ∏∞Ìôî Ìï®Ïàò
------------------------------ */
function initializeSidebar() {
  const tabButtons = document.querySelectorAll('.sidebar-tabs .tab-button'); 
  const tabContents = document.querySelectorAll('.tab-content');

  let isNavigating = false;

  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ------------------------------
    ÌòÑÏû¨ ÌÉ≠Ïù¥ commandsÏù∏ÏßÄ ÌôïÏù∏
  ------------------------------ */
  function isCommandsTab() {
    const activeTabContent = $('.tab-content.active');
    return activeTabContent?.classList.contains('grid-layout');
  }

  /* ------------------------------
    URL Í∏∞Î∞ò Ï¥àÍ∏∞ ÌÉ≠ ÌôúÏÑ±Ìôî
  ------------------------------ */
  function setInitialTab() {
    const path = window.location.pathname;
    let activeTabId = path.includes('/ko/commands/') ? 'commands' : tabButtons[0]?.dataset.tab || 'grimmi';
    activateTab(activeTabId);
  }
  
  /* ------------------------------
    ÌÉ≠ ÌôúÏÑ±Ìôî Í≥µÌÜµ Ìï®Ïàò
  ------------------------------ */
  function activateTab(tabId) {
    // ÌòÑÏû¨ ÌÉ≠ ÏÉÅÌÉú Ï†ÄÏû•
    saveMenuState();
    saveSidebarScroll();

    tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
    tabContents.forEach(content => content.classList.toggle('active', content.dataset.tabContent === tabId));

    // ÏÉà ÌÉ≠ ÏÉÅÌÉú Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏúºÎ°ú DOMÏù¥ ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌõÑ Ïã§Ìñâ)
    requestAnimationFrame(() => {
      restoreMenuState();
      setTimeout(() => {
        restoreSidebarScroll();
      }, 50);
    });
  }

  /* ------------------------------
    ÎßÅÌÅ¨ ÌÅ¥Î¶≠ Ïãú depth Î©îÎâ¥ ÌôúÏÑ±Ìôî
  ------------------------------ */
  function activateDepthMenu(targetPath, skipMenuStateRestore = false) {
    const isCommands = isCommandsTab();

    // üîπ ÌôúÏÑ± ÌëúÏãú Ï¥àÍ∏∞Ìôî
    $(`.depth02 li, .depth03 li`).forEach(li => li.classList.remove('active'));

    // üîπ commands ÌÉ≠Ïùº Í≤ΩÏö∞ÏóêÎßå Î™®Îì† Î©îÎâ¥ Îã´Í∏∞
    if (isCommands) {
      $('.depth01 > li').forEach(li => li.classList.remove('active'));
      $('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
    }
    // üîπ grimmi ÌÉ≠Ïù¥Í≥† Î©îÎâ¥ ÏÉÅÌÉú Î≥µÏõêÏùÑ Í±¥ÎÑàÎõ∞ÏßÄ ÏïäÎäî Í≤ΩÏö∞ÏóêÎßå Î©îÎâ¥ Îã´Í∏∞
    else if (!skipMenuStateRestore) {
      // ÎßÅÌÅ¨ ÏßÅÏ†ë ÌÅ¥Î¶≠ ÏãúÏóêÎßå ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Î©îÎâ¥Îßå ÌôúÏÑ±Ìôî
    }

    // üîπ ÌÅ¥Î¶≠Îêú Î©îÎâ¥Îßå ÌôúÏÑ±Ìôî
    const targetAnchor = $(`a[href]`).find(a => new URL(a.href, location.origin).pathname === targetPath);
    if (!targetAnchor) return;

    const parentLi = targetAnchor.closest('.depth01 > li');
    const parentDepth02 = targetAnchor.closest('.depth02');

    if (parentLi) parentLi.classList.add('active');
    if (parentDepth02 && !parentDepth02.classList.contains('single')) {
      parentDepth02.classList.remove('d-none');
    }

    // üîπ ÌôúÏÑ± ÌëúÏãú
    targetAnchor.parentElement?.classList.add('active');

    // grimmi ÌÉ≠Ïù¥Î©¥ ÏÉÅÌÉú Ï†ÄÏû•
    if (!isCommands) {
      saveMenuState();
    }
  }

  /* ------------------------------
    ÌÉ≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
  ------------------------------ */
  tabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (isNavigating || this.classList.contains('active')) return;

      const tabId = this.dataset.tab;
      const defaultLink = this.dataset.tabLink || '#';
      const lastVisited = sessionStorage.getItem(`lastVisited_${tabId}`) || defaultLink;

      activateTab(tabId);
      
      // üîπ ÌÉ≠ Ï†ÑÌôò ÏãúÏóêÎäî ÌôúÏÑ± ÌëúÏãúÎßå ÏóÖÎç∞Ïù¥Ìä∏ (Î©îÎâ¥ ÏÉÅÌÉúÎäî Ïú†ÏßÄ)
      requestAnimationFrame(() => {
        const targetAnchor = $(`a[href]`).find(a => new URL(a.href, location.origin).pathname === lastVisited);
        if (targetAnchor) {
          // depth02, depth03 ÌôúÏÑ± ÌëúÏãúÎßå ÏóÖÎç∞Ïù¥Ìä∏
          $(`.depth02 li, .depth03 li`).forEach(li => li.classList.remove('active'));
          targetAnchor.parentElement?.classList.add('active');
        }
      });

      isNavigating = true;
      requestAnimationFrame(() => {
        navigate(lastVisited).finally(() => isNavigating = false);
      });
    });
  });

  /* ------------------------------
    depth Î©îÎâ¥ ÌÜ†Í∏Ä
  ------------------------------ */
  $$('.depth01 > li > a[data-toggle]').forEach(menu => {
    const newMenu = menu.cloneNode(true);
    menu.parentNode?.replaceChild(newMenu, menu);

    newMenu.addEventListener('click', function(e) {
      e.preventDefault();
      const parentLi = this.parentElement;
      const toggleId = this.getAttribute('data-toggle');
      const depth02 = toggleId ? document.getElementById(toggleId) : null;

      if (depth02 && !depth02.classList.contains('single')) {
        const isCommands = isCommandsTab();

        if (isCommands) {
          // üîπ Commands ÌÉ≠: ÌïòÎÇòÎßå Ïó¥Î¶º (ÏïÑÏΩîÎîîÏñ∏ Î∞©Ïãù)
          const isCurrentlyOpen = parentLi.classList.contains('active') && !depth02.classList.contains('d-none');
          
          if (isCurrentlyOpen) {
            // Í∞ôÏùÄ Î©îÎâ¥ Ïû¨ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            parentLi.classList.remove('active');
            depth02.classList.add('d-none');
          } else {
            // Îã§Î•∏ Î©îÎâ¥ ÌÅ¥Î¶≠ Ïãú: Î™®Îì† Î©îÎâ¥ Îã´Í≥† ÌÅ¥Î¶≠Ìïú Î©îÎâ¥Îßå Ïó¥Í∏∞
            $$('.depth01 > li').forEach(li => li.classList.remove('active'));
            $$('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
            parentLi.classList.add('active');
            depth02.classList.remove('d-none');
          }
        } else {
          // üîπ Grimmi ÌÉ≠: Ïó¨Îü¨ Î©îÎâ¥ ÎèôÏãú ÌéºÏπ® Í∞ÄÎä• (ÌÜ†Í∏Ä Î∞©Ïãù)
          depth02.classList.toggle('d-none');
          parentLi?.classList.toggle('active');
          
          // ÏÉÅÌÉú Ï†ÄÏû•
          saveMenuState();
        }
      }
    });
  });

  /* ------------------------------
    ÎßÅÌÅ¨ ÌÅ¥Î¶≠ Ïãú lastVisited Ï†ÄÏû•
  ------------------------------ */
  $$('.depth02 a, .depth03 a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (!href || href === '#') {
        e.preventDefault();
        return;
      }

      // ‚úÖ ÌòÑÏû¨ Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû•
      saveSidebarScroll();
      // ‚úÖ Î©îÎâ¥ ÏÉÅÌÉú Ï†ÄÏû•
      saveMenuState();

      const activeTabBtn = $('.sidebar-tabs .tab-button.active');
      if (activeTabBtn) {
        sessionStorage.setItem(
          `lastVisited_${activeTabBtn.dataset.tab}`,
          new URL(href, location.origin).pathname
        );
      }

      activateDepthMenu(new URL(href, location.origin).pathname);
    });
  });

  // Ï¥àÍ∏∞ ÌÉ≠ ÏÑ§Ï†ï Ïã§Ìñâ
  setInitialTab();
}

initializeSidebar();

document.addEventListener('astro:page-load', () => {
  initializeSidebar();
  restoreMenuState();          // Î©îÎâ¥ ÏÉÅÌÉú Î≥µÏõê
  restoreSidebarScroll();      // Ïù¥Ï†Ñ Ïä§ÌÅ¨Î°§ ÏúÑÏπò Î≥µÏõê
  setTimeout(() => {
    scrollActiveDepth02IntoView(); // ÏÑ†ÌÉùÎêú Î©îÎâ¥ Ï§ëÏïô Î∞∞Ïπò
  }, 100);
});

/* ------------------------------
  üîô Îí§Î°úÍ∞ÄÍ∏∞(popstate) Ï≤òÎ¶¨
------------------------------ */
window.addEventListener('popstate', () => {
  const currentPath = window.location.pathname;
  const activeTabContent = document.querySelector('.tab-content.active');
  const isCommands = activeTabContent?.classList.contains('grid-layout');

  // üîπ Ïä§ÌÅ¨Î°§ Î≥µÏõê
  restoreSidebarScroll();

  // üîπ grimmi ÌÉ≠Ïù¥Î©¥ Ï†ÄÏû•Îêú Î©îÎâ¥ ÏÉÅÌÉú Î®ºÏ†Ä Î≥µÏõê
  if (!isCommands) {
    restoreMenuState();
  }

  // üîπ ÌòÑÏû¨ Î©îÎâ¥ Ï∞æÍ∏∞
  const currentAnchor = [...document.querySelectorAll('a[href]')].find(a =>
    new URL(a.href, location.origin).pathname === currentPath
  );
  if (!currentAnchor) return;

  // üîπ ÌôúÏÑ± ÌëúÏãú Ï¥àÍ∏∞Ìôî
  document.querySelectorAll('.depth02 li, .depth03 li').forEach(li => li.classList.remove('active'));

  // üîπ commands ÌÉ≠Ïùº Í≤ΩÏö∞ÏóêÎßå Î™®Îì† Î©îÎâ¥ Îã´Í∏∞
  if (isCommands) {
    document.querySelectorAll('.depth01 > li.active').forEach(li => li.classList.remove('active'));
    document.querySelectorAll('.depth02:not(.single)').forEach(ul => ul.classList.add('d-none'));
  }

  // üîπ ÌòÑÏû¨ Î©îÎâ¥Îßå Ïó¥Í∏∞
  const parentLi = currentAnchor.closest('.depth01 > li');
  const parentDepth02 = currentAnchor.closest('.depth02');

  parentLi?.classList.add('active');
  if (parentDepth02 && !parentDepth02.classList.contains('single')) {
    parentDepth02.classList.remove('d-none');
  }

  currentAnchor.parentElement?.classList.add('active');

  // üîπ ÌôúÏÑ± Î©îÎâ¥ Ï§ëÏïô Î∞∞Ïπò
  setTimeout(scrollActiveDepth02IntoView, 400);
});
</script>