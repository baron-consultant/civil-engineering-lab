---
import MobileMenuFooter from "virtual:starlight/components/MobileMenuFooter";
import SidebarPersister from "@astrojs/starlight/components/SidebarPersister.astro";
import SidebarSublist from "@astrojs/starlight/components/SidebarSublist.astro";

const { sidebar = [] } = Astro.locals.starlightRoute ?? {};
const currentPath = decodeURIComponent(Astro.url.pathname);

const entryContainsPath = (entry) => {
  if (entry.type === "link" && entry.href) {
    const linkHref = decodeURIComponent(entry.href);
    return currentPath.startsWith(linkHref);
  }

  if (entry.type === "group" && Array.isArray(entry.entries)) {
    return entry.entries.some(entryContainsPath);
  }

  return false;
};

const activeTopLevelGroup = sidebar.find(
  (entry) => entry.type === "group" && entryContainsPath(entry),
);

const filteredSidebar =
  activeTopLevelGroup && Array.isArray(activeTopLevelGroup.entries)
    ? activeTopLevelGroup.entries
    : sidebar;

---

<SidebarPersister>
	<SidebarSublist sublist={filteredSidebar} />
</SidebarPersister>

<div class="md:sl-hidden">
	<MobileMenuFooter />
</div>
