---
import Sidebar from "@astrojs/starlight/components/Sidebar.astro";

// Extract the top-level section from the current URL
const { slug } = Astro.params;
const currentPath = Astro.url.pathname;

// Define known top-level sections (slugified)
// "Civil DX" -> "civil-dx"
// "기반기술" -> "기반기술" (encoded or as is, depending on slugification)
// Let's rely on checking the first segment of the path after base.
// Base is '/', so path starts with /civil-dx/, /%EA%B8%B0%EB%B0%98%EA%B8%B0%EC%88%A0/ (encoded), etc.

// Helper to get top-level folder name from sidebar groups
// We look for a group that matches the current URL start.

const sidebar = Astro.props.sidebar || [];
console.log("Current Path:", currentPath);
console.log("Sidebar Structure:", JSON.stringify(sidebar, null, 2));

// Find the group that corresponds to the current section
// In autogenerated sidebar, the top-level folders become the first-level groups.
// e.g., Group "Civil DX", Group "기반기술"

let filteredSidebar = sidebar;

// Logic: Find which top-level group's children are relevant.
// We assume the top-level groups ARE the sections.
// We want to show only the CHILDREN of the matching top-level group.

const activeTopLevelGroup =
    sidebar && sidebar.length > 0
        ? sidebar.find((group) => {
              // Check if any item in this group is active or if the group label matches the current path segment roughly.
              // A better way is checking if the current URL starts with one of the group's items' hrefs prefix.

              // Simplistic check: does the group label match the first path segment?
              // "Civil DX" -> URL usually /civil-dx/...

              if (group.type !== "group") return false;

              // Check purely by whether one of its items is the current page or parent of current page
              // BUT Starlight doesn't easily expose "isActive" on the group itself in props.
              // We can iterate entries.

              // Let's look at the group label.
              // Labels: "Civil DX", "기반기술", "설계", "시공"

              // Map labels to URL prefixes if proper slugification is known.
              // civil-dx, 기반기술, 설계, 시공.

              const label = group.label;
              // Simple heuristic: if the current path includes the slugified label.
              // However, Korean characters in URL might be encoded.

              const encodedPath = decodeURIComponent(currentPath);

              // Slugify label simple version for check
              const slugifiedLabel = label.toLowerCase().replace(/\s+/g, "-");

              if (
                  encodedPath.includes(`/${slugifiedLabel}/`) ||
                  encodedPath.includes(`/${label}/`)
              ) {
                  return true;
              }
              return false;
          })
        : null;

if (activeTopLevelGroup && activeTopLevelGroup.entries) {
    // Show only the children of this group
    // This "promotes" the 2nd level to the root of the sidebar
    filteredSidebar = activeTopLevelGroup.entries;
} else {
    // Fallback: If no section matches (e.g. root or unknown), show everything or nothing?
    // User wants Contextual. If at root, maybe show nothing? or all?
    // Let's show all for now or maybe hidden.
    // If we are at /, there is no section.
}

// Pass selected items to the original Sidebar component
---

<Sidebar {...Astro.props} sidebar={filteredSidebar} />
